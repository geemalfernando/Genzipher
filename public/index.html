<!doctype html>
<html lang="en" data-color-mode="light" data-light-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GenZipher Healthcare Trust Platform (MVP)</title>
    <link rel="stylesheet" href="https://unpkg.com/@primer/css@17.0.1/dist/primer.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="p-3 p-md-4">
    <main class="container-xl">
      <div class="gz-hero p-3 p-md-4 mb-3">
        <div class="d-flex flex-justify-between flex-items-center flex-wrap gap-2">
          <div>
            <div class="d-flex flex-items-center gap-2">
              <span class="Label Label--success">MVP</span>
              <h1 class="f3 mb-0">GenZipher Healthcare Security & Trust Platform</h1>
            </div>
            <p class="color-fg-muted mt-1 mb-0">
              Blocks identity hijacking • Encrypts vitals • Prevents prescription tamper • Stops placebo swaps
            </p>
          </div>
          <div class="gz-pill">
            <span class="gz-status">
              <span id="apiDot" class="gz-dot"></span>
              <span id="apiStatusText" class="text-small color-fg-muted">Checking API…</span>
            </span>
            <span class="color-fg-muted">•</span>
            <span class="text-small">Session: <span id="whoami" class="gz-mono">—</span></span>
            <button id="logoutBtn" class="btn btn-sm" hidden>Logout</button>
          </div>
        </div>
      </div>

      <div id="toast" class="flash" hidden></div>

      <div class="gz-grid">
        <section class="Box p-3" id="loginBox">
          <div class="d-flex flex-justify-between flex-items-center">
            <h2 class="f4 mb-0">Access</h2>
            <div class="BtnGroup">
              <button id="tabLogin" class="BtnGroup-item btn btn-sm btn-primary" type="button">Login</button>
              <button id="tabRegister" class="BtnGroup-item btn btn-sm" type="button">Register patient</button>
            </div>
          </div>

          <p class="color-fg-muted text-small mt-2">
            Demo MFA code for doctor/pharmacy/manufacturer/admin: <span class="gz-mono">123456</span>
          </p>

          <div id="loginPane">
            <form id="loginForm" class="d-flex flex-column gap-2">
              <label class="form-group">
                <div class="text-small color-fg-muted">Username</div>
                <input id="login_username" class="form-control input-block" value="doctor1" />
              </label>
              <label class="form-group">
                <div class="text-small color-fg-muted">Password</div>
                <input id="login_password" class="form-control input-block" type="password" value="password123" />
              </label>
              <label class="form-group">
                <div class="text-small color-fg-muted">MFA (optional)</div>
                <input id="login_mfa" class="form-control input-block" placeholder="123456" />
              </label>
              <button class="btn btn-primary" type="submit">Login</button>
              <div class="color-fg-muted text-small">
                Try: <span class="gz-mono">doctor1</span>, <span class="gz-mono">mfg1</span>, <span class="gz-mono">pharmacy1</span>, <span class="gz-mono">admin1</span>, <span class="gz-mono">patient1</span>
              </div>
            </form>
          </div>

          <div id="registerPane" hidden>
            <h3 class="f5 mt-2">Patient pre-registration</h3>
            <p class="color-fg-muted text-small">
              Creates a patient in <span class="gz-mono">PENDING</span> unless Trust Score ≥ 80. Use the clinic code flow to verify.
            </p>

            <form id="preRegisterForm" class="d-flex flex-column gap-2">
              <label class="form-group">
                <div class="text-small color-fg-muted">New username</div>
                <input id="pr_username" class="form-control input-block" placeholder="newpatient1" />
              </label>
              <label class="form-group">
                <div class="text-small color-fg-muted">New password</div>
                <input id="pr_password" class="form-control input-block" type="password" placeholder="Choose a password" />
              </label>
              <div class="d-flex gap-2">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Geo (optional)</div>
                  <input id="pr_geo" class="form-control input-block" placeholder="Clinic-A" />
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Device ID (optional)</div>
                  <input id="pr_deviceId" class="form-control input-block" placeholder="wearable-01" />
                </label>
              </div>
              <button class="btn btn-primary" type="submit">Pre-register</button>
            </form>

            <h4 class="f6 mt-3 mb-1">Result</h4>
            <textarea id="pr_out" class="form-control input-block gz-json" placeholder="Pre-register output…"></textarea>

            <h3 class="f5 mt-3">Verify with clinic code</h3>
            <form id="verifyClinicForm" class="d-flex flex-column gap-2">
              <div class="d-flex gap-2">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Patient username (or leave blank and use Patient ID)</div>
                  <input id="vc_username" class="form-control input-block" placeholder="newpatient1" />
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Patient ID (optional)</div>
                  <input id="vc_patientId" class="form-control input-block" placeholder="u_patient_..." />
                </label>
              </div>
              <label class="form-group">
                <div class="text-small color-fg-muted">Clinic code (one-time)</div>
                <input id="vc_code" class="form-control input-block" placeholder="8-char code" />
              </label>
              <button class="btn" type="submit">Verify clinic code</button>
            </form>

            <h4 class="f6 mt-3 mb-1">Verification result</h4>
            <textarea id="vc_out" class="form-control input-block gz-json" placeholder="Verify output…"></textarea>
          </div>
        </section>

        <section class="Box p-3" id="appBox" hidden>
          <h2 class="f4">Role Workspace</h2>
          <p class="color-fg-muted text-small">
            Current role: <span id="currentRole" class="gz-mono">—</span>
          </p>

          <div id="role_doctor" hidden>
            <h3 class="f5 mt-3">Doctor: Sign Prescription</h3>
            <form id="rxForm" class="d-flex flex-column gap-2">
              <label class="form-group">
                <div class="text-small color-fg-muted">Patient</div>
                <select id="rx_patientUserId" class="form-select input-block"></select>
              </label>
              <div class="d-flex gap-2">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Medicine ID</div>
                  <input id="rx_medicineId" class="form-control input-block" value="MED-AMOX-500" />
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Dosage</div>
                  <input id="rx_dosage" class="form-control input-block" value="500mg" />
                </label>
              </div>
              <label class="form-group">
                <div class="text-small color-fg-muted">Duration (days)</div>
                <input id="rx_durationDays" class="form-control input-block" type="number" value="7" />
              </label>
              <button class="btn btn-primary" type="submit">Create + Sign Rx</button>
            </form>

            <div class="d-flex flex-justify-between flex-items-center mt-3">
              <h4 class="f6 mb-0">Signed Prescription JSON</h4>
              <div class="d-flex gap-2">
                <button id="copyRxBtn" class="btn btn-sm">Copy</button>
                <button id="rxTamperBtn" class="btn btn-sm btn-danger">Tamper</button>
                <button id="rxVerifyBtn" class="btn btn-sm">Verify</button>
              </div>
            </div>
            <textarea id="rx_out" class="form-control input-block gz-json mt-2" placeholder="Create an Rx to populate…"></textarea>
            <textarea id="rx_verify_out" class="form-control input-block gz-json mt-2" placeholder="Verification result…"></textarea>
          </div>

          <div id="role_manufacturer" hidden>
            <h3 class="f5 mt-3">Manufacturer: Sign Batch Certificate</h3>
            <form id="batchForm" class="d-flex flex-column gap-2">
              <div class="d-flex gap-2">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Batch ID</div>
                  <input id="batch_batchId" class="form-control input-block" value="BATCH-2026-0001" />
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Lot</div>
                  <input id="batch_lot" class="form-control input-block" value="LOT-ALPHA" />
                </label>
              </div>
              <div class="d-flex gap-2">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Expiry (ISO date)</div>
                  <input id="batch_expiry" class="form-control input-block" type="date" />
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Certificate Hash</div>
                  <input id="batch_certHash" class="form-control input-block" value="sha256:demo-cert-hash" />
                </label>
              </div>
              <button class="btn btn-primary" type="submit">Register + Sign Batch</button>
            </form>

            <div class="d-flex flex-justify-between flex-items-center mt-3">
              <h4 class="f6 mb-0">Signed Batch JSON</h4>
              <div class="d-flex gap-2">
                <button id="copyBatchBtn" class="btn btn-sm">Copy</button>
                <button id="batchTamperBtn" class="btn btn-sm btn-danger">Tamper</button>
                <button id="batchVerifyBtn" class="btn btn-sm">Verify</button>
              </div>
            </div>
            <textarea id="batch_out" class="form-control input-block gz-json mt-2" placeholder="Create a batch to populate…"></textarea>
            <textarea id="batch_verify_out" class="form-control input-block gz-json mt-2" placeholder="Verification result…"></textarea>
          </div>

          <div id="role_pharmacy" hidden>
            <h3 class="f5 mt-3">Pharmacy: Dispense Gate (Rx + Batch)</h3>
            <form id="dispenseForm" class="d-flex flex-column gap-2">
              <div class="d-flex flex-justify-between flex-items-center">
                <div class="text-small color-fg-muted">Prescription JSON</div>
                <button id="useRxBtn" class="btn btn-sm" type="button">Use last Rx</button>
              </div>
              <textarea id="dispense_rx" class="form-control input-block gz-json" placeholder="Paste signed prescription JSON…"></textarea>
              <div class="d-flex flex-justify-between flex-items-center">
                <div class="text-small color-fg-muted">Batch JSON</div>
                <button id="useBatchBtn" class="btn btn-sm" type="button">Use last batch</button>
              </div>
              <textarea id="dispense_batch" class="form-control input-block gz-json" placeholder="Paste signed batch JSON…"></textarea>
              <button class="btn btn-primary" type="submit">Dispense</button>
            </form>
            <textarea id="dispense_out" class="form-control input-block gz-json mt-2" placeholder="Dispense result…"></textarea>
          </div>

          <div id="role_admin" hidden>
            <h3 class="f5 mt-3">Admin/Compliance: Audit Log</h3>
            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Issue clinic verification code</h4>
              <form id="clinicCodeForm" class="d-flex flex-column gap-2">
                <div class="d-flex gap-2">
                  <label class="form-group flex-1">
                    <div class="text-small color-fg-muted">Bind to patientId (optional)</div>
                    <input id="cc_patientId" class="form-control input-block" placeholder="u_patient_..." />
                  </label>
                  <label class="form-group flex-1">
                    <div class="text-small color-fg-muted">Expires (minutes)</div>
                    <input id="cc_expires" class="form-control input-block" type="number" value="10" />
                  </label>
                </div>
                <button class="btn btn-sm" type="submit">Generate code</button>
              </form>
              <div class="mt-2">
                <div class="text-small color-fg-muted">Generated code</div>
                <div class="d-flex gap-2 flex-items-center">
                  <code id="cc_code" class="gz-mono">—</code>
                  <button id="cc_copy" class="btn btn-sm" type="button">Copy</button>
                </div>
                <div class="text-small color-fg-muted mt-1">
                  Expiry: <span id="cc_expiry" class="gz-mono">—</span>
                </div>
              </div>
            </div>
            <button id="auditLoadBtn" class="btn btn-primary btn-sm">Load latest 200 entries</button>
            <textarea id="audit_out" class="form-control input-block gz-json mt-2" placeholder="Audit entries…"></textarea>
          </div>

          <div id="role_patient" hidden>
            <h3 class="f5 mt-3">Patient</h3>
            <div class="Box p-2 mt-2">
              <div class="d-flex flex-justify-between flex-items-center">
                <h4 class="f6 mb-0">Profile</h4>
                <button id="patientRefreshBtn" class="btn btn-sm" type="button">Refresh</button>
              </div>
              <textarea id="patient_profile_out" class="form-control input-block gz-json mt-2" placeholder="Profile…"></textarea>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Issue DID</h4>
              <button id="patientIssueDidBtn" class="btn btn-sm" type="button">Issue DID</button>
              <code id="patient_did" class="gz-mono d-block mt-2">—</code>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Provision data key</h4>
              <button id="patientProvisionKeyBtn" class="btn btn-sm" type="button">Provision</button>
              <div class="text-small color-fg-muted mt-1">
                Patient token: <span id="patient_token" class="gz-mono">—</span>
              </div>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Bind device (challenge → verify)</h4>
              <form id="bindDeviceForm" class="d-flex flex-column gap-2">
                <label class="form-group">
                  <div class="text-small color-fg-muted">Device ID</div>
                  <input id="bd_deviceId" class="form-control input-block" placeholder="wearable-01" />
                </label>
                <label class="form-group">
                  <div class="text-small color-fg-muted">Device public key PEM (Ed25519)</div>
                  <textarea id="bd_publicKeyPem" class="form-control input-block gz-json" placeholder="-----BEGIN PUBLIC KEY-----..."></textarea>
                </label>
                <label class="form-group">
                  <div class="text-small color-fg-muted">Fingerprint hash (optional)</div>
                  <input id="bd_fingerprint" class="form-control input-block" placeholder="sha256:..." />
                </label>
                <button class="btn btn-sm" type="submit">Create challenge</button>
              </form>

              <div class="mt-2">
                <div class="text-small color-fg-muted">Challenge payload to sign</div>
                <textarea id="bd_challenge" class="form-control input-block gz-json" placeholder='{"deviceId":"...","nonce":"..."}'></textarea>
              </div>

              <form id="verifyDeviceForm" class="d-flex flex-column gap-2 mt-2">
                <label class="form-group">
                  <div class="text-small color-fg-muted">Signature (base64url) over challenge payload</div>
                  <input id="bd_signature" class="form-control input-block" placeholder="base64url..." />
                </label>
                <button class="btn btn-sm btn-primary" type="submit">Verify device</button>
              </form>
              <textarea id="bd_out" class="form-control input-block gz-json mt-2" placeholder="Bind/verify output…"></textarea>
              <p class="color-fg-muted text-small mt-2 mb-0">
                Tip: sign the challenge in a device app. For demo: generate keys + signature with <span class="gz-mono">node scripts/device-sign.js</span>.
              </p>
            </div>
          </div>
        </section>
      </div>

      <footer class="mt-4 color-fg-muted text-small">
        Tip: run <span class="gz-mono">npm run seed</span> then <span class="gz-mono">npm run dev</span>.
      </footer>
    </main>

    <script src="app.js" type="module"></script>
  </body>
</html>
