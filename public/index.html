<!doctype html>
<html lang="en" data-color-mode="light" data-light-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GenZipher Healthcare Trust Platform (MVP)</title>
    <link rel="stylesheet" href="https://unpkg.com/@primer/css@17.0.1/dist/primer.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="container-xl">
      <div class="gz-hero p-3 p-md-4 mb-3">
        <div class="d-flex flex-justify-between flex-items-center flex-wrap gap-2">
          <div>
            <div class="d-flex flex-items-center gap-2">
              <span class="Label Label--success">MVP</span>
              <h1 class="f3 mb-0">GenZipher Healthcare Security & Trust Platform</h1>
            </div>
            <p class="color-fg-muted mt-1 mb-0">
              Blocks identity hijacking • Encrypts vitals • Prevents prescription tamper • Stops placebo swaps
            </p>
          </div>
          <div class="gz-pill">
            <span class="gz-status">
              <span id="apiDot" class="gz-dot"></span>
              <span id="apiStatusText" class="text-small color-fg-muted">Checking API…</span>
            </span>
            <span class="color-fg-muted">•</span>
            <span class="text-small">Session: <span id="whoami" class="gz-mono">—</span></span>
            <button id="logoutBtn" class="btn btn-sm" hidden>Logout</button>
          </div>
        </div>
      </div>

      <div id="toast" class="flash" hidden></div>

      <div class="gz-grid" id="mainGrid">
        <section class="Box p-3" id="loginBox">
          <div class="d-flex flex-justify-between flex-items-center">
            <h2 class="f4 mb-0">Access</h2>
            <div class="BtnGroup">
              <button id="tabLogin" class="BtnGroup-item btn btn-sm btn-primary" type="button">Login</button>
              <button id="tabRegister" class="BtnGroup-item btn btn-sm" type="button">Register patient</button>
            </div>
          </div>

          <p class="color-fg-muted text-small mt-2">
            Demo MFA code for doctor/pharmacy/manufacturer/admin: <span class="gz-mono">123456</span>
          </p>

          <div id="loginPane">
            <form id="loginForm" class="d-flex flex-column gap-2">
              <label class="form-group">
                <div class="text-small color-fg-muted">Username or email</div>
                <input id="login_identifier" class="form-control input-block" value="doctor1" />
              </label>
              <label class="form-group">
                <div class="text-small color-fg-muted">Password</div>
                <input id="login_password" class="form-control input-block" type="password" value="password123" />
              </label>
              <div class="form-checkbox">
                <label>
                  <input id="login_show_password" type="checkbox" />
                  Show password
                </label>
              </div>
              <label class="form-group">
                <div class="text-small color-fg-muted">MFA (required for admin/doctor/pharmacy/manufacturer)</div>
                <input id="login_mfa" class="form-control input-block" placeholder="123456" />
              </label>
              <button class="btn btn-primary" type="submit">Login</button>
              <div class="color-fg-muted text-small">
                Try: <span class="gz-mono">doctor1</span>, <span class="gz-mono">mfg1</span>, <span class="gz-mono">pharmacy1</span>, <span class="gz-mono">admin1</span>, <span class="gz-mono">patient1</span>
              </div>
              <div class="text-center mt-2">
                <a href="/pharmacist/signup" class="text-small color-fg-blue">Register as Pharmacist</a>
              </div>
              <div class="text-center mt-2">
                <button id="forgotToggleBtn" class="btn-link text-small" type="button">Forgot password?</button>
              </div>
            </form>

            <div id="forgotBox" class="Box p-2 mt-3" hidden>
              <h3 class="f6 mb-1">Reset password (Email OTP)</h3>
              <p class="color-fg-muted text-small mb-2">
                Enter your username/email. We’ll send a 6-digit code to your email if the account has one.
              </p>
              <form id="forgotRequestForm" class="d-flex flex-column gap-2">
                <label class="form-group">
                  <div class="text-small color-fg-muted">Username or email</div>
                  <input id="forgot_identifier" class="form-control input-block" placeholder="patient@example.com" />
                </label>
                <button id="forgotRequestBtn" class="btn" type="submit">Send code</button>
              </form>

              <div id="forgotOtpBox" class="mt-2" hidden>
                <form id="forgotConfirmForm" class="d-flex flex-column gap-2">
                  <label class="form-group">
                    <div class="text-small color-fg-muted">OTP</div>
                    <input id="forgot_otp" class="form-control input-block" inputmode="numeric" placeholder="123456" />
                  </label>
                  <div class="text-small color-fg-muted">
                    Remaining attempts: <span id="forgot_remaining" class="gz-mono">3</span>
                  </div>
                  <div class="d-flex gap-2">
                    <button id="forgotConfirmBtn" class="btn btn-primary" type="submit">Verify OTP</button>
                    <button id="forgotResendBtn" class="btn" type="button">Resend</button>
                  </div>
                  <div class="text-small color-fg-muted">
                    otpRequestId: <span id="forgot_otp_id" class="gz-mono">—</span>
                  </div>
                </form>
              </div>

              <div id="forgotSetBox" class="mt-2" hidden>
              <form id="forgotSetForm" class="d-flex flex-column gap-2">
                <label class="form-group">
                  <div class="text-small color-fg-muted">New password</div>
                  <input id="forgot_new_password" class="form-control input-block" type="password" placeholder="New password (min 8 chars)" />
                </label>
                <div class="form-checkbox">
                  <label>
                    <input id="forgot_show_password" type="checkbox" />
                    Show password
                  </label>
                </div>
                <button id="forgotSetBtn" class="btn btn-primary" type="submit">Set new password</button>
              </form>
            </div>
          </div>

            <div id="otpBox" class="Box p-2 mt-3" hidden>
              <h3 class="f6 mb-1">Email OTP</h3>
              <p class="color-fg-muted text-small mb-2">
                Enter the 6-digit code. (MVP delivery: check server terminal logs.)
              </p>
              <form id="otpForm" class="d-flex flex-column gap-2">
                <label class="form-group">
                  <div class="text-small color-fg-muted">OTP</div>
                  <input id="otp_code" class="form-control input-block" inputmode="numeric" placeholder="123456" />
                </label>
                <div class="form-checkbox">
                  <label>
                    <input id="otp_remember" type="checkbox" checked />
                    Trust this device (skip OTP for 30 days)
                  </label>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" type="submit">Verify OTP</button>
                  <button id="otpResendBtn" class="btn" type="button">Resend</button>
                </div>
                <div class="text-small color-fg-muted">
                  Expires: <span id="otp_expires" class="gz-mono">—</span> • Sent to: <span id="otp_sentTo" class="gz-mono">—</span>
                </div>
              </form>
            </div>
          </div>

          <div id="registerPane" hidden>
            <h3 class="f5 mt-2">Patient pre-registration</h3>
            <p class="color-fg-muted text-small">
              Creates a patient in <span class="gz-mono">PENDING</span> unless Trust Score ≥ 80. Use the clinic code flow to verify.
            </p>

            <form id="preRegisterForm" class="d-flex flex-column gap-2">
              <label class="form-group">
                <div class="text-small color-fg-muted">New username</div>
                <input id="pr_username" class="form-control input-block" placeholder="newpatient1" />
              </label>
              <label class="form-group">
                <div class="text-small color-fg-muted">Email</div>
                <input id="pr_email" class="form-control input-block" placeholder="patient@example.com" />
              </label>
              <label class="form-group">
                <div class="text-small color-fg-muted">New password</div>
                <input id="pr_password" class="form-control input-block" type="password" placeholder="Choose a password" />
              </label>
              <div class="form-checkbox">
                <label>
                  <input id="pr_show_password" type="checkbox" />
                  Show password
                </label>
              </div>
              <button class="btn btn-primary" type="submit">Pre-register</button>
            </form>

            <h4 class="f6 mt-3 mb-1">Result</h4>
            <textarea id="pr_out" class="form-control input-block gz-json" placeholder="Pre-register output…"></textarea>

            <h3 class="f5 mt-3">Verify your account</h3>
            <form id="verifyClinicForm" class="d-flex flex-column gap-2">
              <div class="d-flex gap-2">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Patient username (or leave blank and use Patient ID)</div>
                  <input id="vc_username" class="form-control input-block" placeholder="newpatient1" />
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Patient ID (optional)</div>
                  <input id="vc_patientId" class="form-control input-block" placeholder="u_patient_..." />
                </label>
              </div>
              <label class="form-group">
                <div class="text-small color-fg-muted">Verification code (one-time)</div>
                <input id="vc_code" class="form-control input-block" placeholder="8-char code" />
              </label>
              <button class="btn" type="submit">Verify code</button>
            </form>

            <h4 class="f6 mt-3 mb-1">Verification result</h4>
            <textarea id="vc_out" class="form-control input-block gz-json" placeholder="Verify output…"></textarea>
          </div>
        </section>

        <section class="Box p-3" id="appBox" hidden>
          <h2 class="f4">Role Workspace</h2>
          <p class="color-fg-muted text-small">
            Current role: <span id="currentRole" class="gz-mono">—</span>
          </p>

          <div id="role_doctor" hidden>
            <div class="d-flex flex-justify-between flex-items-center mb-2">
              <h3 class="f5 mt-3 mb-0">Doctor: Sign Prescription</h3>
              <div class="BtnGroup">
                <button id="tabRx" class="BtnGroup-item btn btn-sm btn-primary" type="button">Create Rx</button>
                <button id="tabPatientSearch" class="BtnGroup-item btn btn-sm" type="button">Search Patients</button>
              </div>
            </div>
            
            <!-- Patient Search Tab -->
            <div id="doctorPatientSearchPane" hidden>
              <div class="Box p-3 mb-3">
                <label class="form-group">
                  <div class="text-small color-fg-muted mb-1">Search Patient</div>
                  <div class="position-relative">
                    <input 
                      id="doctor_patientSearch" 
                      class="form-control input-block" 
                      type="text" 
                      placeholder="Search by patient name or ID (min 2 characters)" 
                      autocomplete="off"
                    />
                    <div id="doctor_patientSearchResults" class="Box" style="display: none; max-height: 300px; overflow-y: auto;">
                      <!-- Search results will appear here -->
                    </div>
                  </div>
                </label>
              </div>
              
              <div id="doctor_patientDetails" class="Box p-3" style="display: none;">
                <h4 class="f6 mb-2">Patient Details</h4>
                <div id="doctor_patientInfo" class="mb-3"></div>
                <div class="d-flex gap-2">
                  <button id="doctor_viewHistoryBtn" class="btn btn-sm">View History</button>
                  <button id="doctor_viewPrescriptionsBtn" class="btn btn-sm">View Prescriptions</button>
                </div>
                <div id="doctor_patientData" class="mt-3"></div>
              </div>
            </div>
            
            <!-- Prescription Creation Tab -->
            <div id="doctorRxPane">
            <form id="rxForm" class="d-flex flex-column gap-2">
              <label class="form-group">
                <div class="text-small color-fg-muted">Patient</div>
                <select id="rx_patientUserId" class="form-select input-block"></select>
              </label>
              
              <div class="Box p-3" style="margin-bottom: 16px;">
                <label class="form-group">
                  <div class="text-small color-fg-muted mb-1">Search Medicine</div>
                  <div class="position-relative">
                    <input 
                      id="rx_medicineSearch" 
                      class="form-control input-block" 
                      type="text" 
                      placeholder="Type to search medicines (e.g., Amoxicillin, Paracetamol...)" 
                      autocomplete="off"
                    />
                    <div id="rx_medicineSearchResults" class="Box" style="display: none; max-height: 300px; overflow-y: auto;">
                      <!-- Search results will appear here -->
                    </div>
                  </div>
                </label>
              </div>
              
              <div class="Box p-3" style="margin-top: 0;">
                <div class="d-flex flex-justify-between flex-items-center mb-2">
                  <h4 class="f6 mb-0">Selected Medicines</h4>
                  <button id="rx_addMedicineBtn" class="btn btn-sm btn-primary" type="button" style="display: none;">+ Add Manually</button>
                </div>
                
                <div id="rx_medicinesTable" class="overflow-auto">
                  <table class="table" style="min-width: 100%;">
                    <thead>
                      <tr>
                        <th>Medicine Name</th>
                        <th>Dosage</th>
                        <th>Duration (days)</th>
                        <th style="width: 80px;">Action</th>
                      </tr>
                    </thead>
                    <tbody id="rx_medicinesTbody">
                      <!-- Medicines will be added here dynamically -->
                    </tbody>
                  </table>
                  <div id="rx_noMedicines" class="color-fg-muted text-small text-center p-3">
                    No medicines added. Search and select medicines above.
                  </div>
                </div>
              </div>
              
              <button class="btn btn-primary" type="submit" id="rx_submitBtn" disabled>Create + Sign Prescription</button>
            </form>
            </div>

            <div class="d-flex flex-justify-between flex-items-center mt-3">
              <h4 class="f6 mb-0">Signed Prescription JSON</h4>
              <div class="d-flex gap-2">
                <button id="copyRxBtn" class="btn btn-sm">Copy</button>
                <button id="rxTamperBtn" class="btn btn-sm btn-danger">Tamper</button>
                <button id="rxVerifyBtn" class="btn btn-sm">Verify</button>
              </div>
            </div>
            <textarea id="rx_out" class="form-control input-block gz-json mt-2" placeholder="Create an Rx to populate…"></textarea>
            <textarea id="rx_verify_out" class="form-control input-block gz-json mt-2" placeholder="Verification result…"></textarea>
          </div>

          <div id="role_manufacturer" hidden>
            <h3 class="f5 mt-3">Manufacturer: Sign Batch Certificate</h3>
            <form id="batchForm" class="d-flex flex-column gap-2">
              <div class="d-flex gap-2">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Batch ID</div>
                  <input id="batch_batchId" class="form-control input-block" value="BATCH-2026-0001" />
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Lot</div>
                  <input id="batch_lot" class="form-control input-block" value="LOT-ALPHA" />
                </label>
              </div>
              <div class="d-flex gap-2">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Expiry (ISO date)</div>
                  <input id="batch_expiry" class="form-control input-block" type="date" />
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Certificate Hash</div>
                  <input id="batch_certHash" class="form-control input-block" value="sha256:demo-cert-hash" />
                </label>
              </div>
              <button class="btn btn-primary" type="submit">Register + Sign Batch</button>
            </form>

            <div class="d-flex flex-justify-between flex-items-center mt-3">
              <h4 class="f6 mb-0">Signed Batch JSON</h4>
              <div class="d-flex gap-2">
                <button id="copyBatchBtn" class="btn btn-sm">Copy</button>
                <button id="batchTamperBtn" class="btn btn-sm btn-danger">Tamper</button>
                <button id="batchVerifyBtn" class="btn btn-sm">Verify</button>
              </div>
            </div>
            <textarea id="batch_out" class="form-control input-block gz-json mt-2" placeholder="Create a batch to populate…"></textarea>
            <textarea id="batch_verify_out" class="form-control input-block gz-json mt-2" placeholder="Verification result…"></textarea>
          </div>

          <div id="role_pharmacy" hidden>
            <div class="d-flex flex-justify-between flex-items-center mb-3">
              <h3 class="f5 mt-3 mb-0">Pharmacist Dashboard</h3>
              <div class="BtnGroup">
                <button id="pharmTabDashboard" class="BtnGroup-item btn btn-sm btn-primary" type="button">Dashboard</button>
                <button id="pharmTabMedicines" class="BtnGroup-item btn btn-sm" type="button">Medicines</button>
                <button id="pharmTabStock" class="BtnGroup-item btn btn-sm" type="button">Stock</button>
                <button id="pharmTabQuality" class="BtnGroup-item btn btn-sm" type="button">Quality</button>
                <button id="pharmTabDispense" class="BtnGroup-item btn btn-sm" type="button">Dispense</button>
              </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="pharmDashboardPane">
              <div class="Box p-3 mb-3">
                <h4 class="f6 mb-2">Statistics</h4>
                <button id="pharmLoadDashboard" class="btn btn-sm btn-primary mb-2">Refresh Dashboard</button>
                <div id="pharmDashboardStats" class="d-flex flex-wrap gap-3">
                  <div class="Box p-2" style="flex: 1; min-width: 150px;">
                    <div class="text-small color-fg-muted">Total Medicines</div>
                    <div id="pharmStatMedicines" class="f3">—</div>
                  </div>
                  <div class="Box p-2" style="flex: 1; min-width: 150px;">
                    <div class="text-small color-fg-muted">Stock Items</div>
                    <div id="pharmStatStock" class="f3">—</div>
                  </div>
                  <div class="Box p-2" style="flex: 1; min-width: 150px;">
                    <div class="text-small color-fg-muted">Low Stock</div>
                    <div id="pharmStatLowStock" class="f3 color-fg-attention">—</div>
                  </div>
                  <div class="Box p-2" style="flex: 1; min-width: 150px;">
                    <div class="text-small color-fg-muted">Expired Items</div>
                    <div id="pharmStatExpired" class="f3 color-fg-danger">—</div>
                  </div>
                  <div class="Box p-2" style="flex: 1; min-width: 150px;">
                    <div class="text-small color-fg-muted">Pending Verifications</div>
                    <div id="pharmStatPending" class="f3">—</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Medicines Tab -->
            <div id="pharmMedicinesPane" hidden>
              <div class="Box p-3 mb-3">
                <div class="d-flex flex-justify-between flex-items-center mb-2">
                  <h4 class="f6 mb-0">Medicines</h4>
                  <button id="pharmAddMedicineBtn" class="btn btn-sm btn-primary">+ Add Medicine</button>
                </div>
                <div class="d-flex gap-2 mb-2">
                  <input id="pharmMedicineSearch" class="form-control flex-1" type="text" placeholder="Search medicines..." />
                  <select id="pharmMedicineCategory" class="form-select" style="width: 200px;">
                    <option value="">All Categories</option>
                    <option value="Antibiotic">Antibiotic</option>
                    <option value="Analgesic">Analgesic</option>
                    <option value="Antihypertensive">Antihypertensive</option>
                    <option value="Antidiabetic">Antidiabetic</option>
                    <option value="Cardiovascular">Cardiovascular</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div id="pharmMedicinesList" class="color-fg-muted text-small">Loading medicines...</div>
              </div>

              <!-- Add/Edit Medicine Modal -->
              <div id="pharmMedicineModal" class="Box p-3" style="display: none;">
                <h4 class="f6 mb-2" id="pharmMedicineModalTitle">Add Medicine</h4>
                <form id="pharmMedicineForm" class="d-flex flex-column gap-2">
                  <input type="hidden" id="pharmMedicineId" />
                  <div class="d-flex gap-2">
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Name *</div>
                      <input id="pharmMedicineName" class="form-control input-block" required />
                    </label>
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Generic Name</div>
                      <input id="pharmMedicineGeneric" class="form-control input-block" />
                    </label>
                  </div>
                  <div class="d-flex gap-2">
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Manufacturer *</div>
                      <input id="pharmMedicineManufacturer" class="form-control input-block" required />
                    </label>
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Category *</div>
                      <select id="pharmMedicineCategorySelect" class="form-select input-block" required>
                        <option value="">Select...</option>
                        <option value="Antibiotic">Antibiotic</option>
                        <option value="Analgesic">Analgesic</option>
                        <option value="Antihypertensive">Antihypertensive</option>
                        <option value="Antidiabetic">Antidiabetic</option>
                        <option value="Cardiovascular">Cardiovascular</option>
                        <option value="Other">Other</option>
                      </select>
                    </label>
                  </div>
                  <label class="form-group">
                    <div class="text-small color-fg-muted">Dosage Forms (comma-separated)</div>
                    <input id="pharmMedicineDosageForms" class="form-control input-block" placeholder="e.g., Tablet, Capsule, Syrup" />
                  </label>
                  <label class="form-group">
                    <div class="text-small color-fg-muted">Strengths (comma-separated)</div>
                    <input id="pharmMedicineStrengths" class="form-control input-block" placeholder="e.g., 250mg, 500mg" />
                  </label>
                  <label class="form-group">
                    <div class="text-small color-fg-muted">Description</div>
                    <textarea id="pharmMedicineDescription" class="form-control input-block" rows="2"></textarea>
                  </label>
                  <div class="d-flex gap-2">
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Storage Conditions</div>
                      <input id="pharmMedicineStorage" class="form-control input-block" placeholder="e.g., Store at room temperature" />
                    </label>
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Expiry Period (days)</div>
                      <input id="pharmMedicineExpiryPeriod" class="form-control input-block" type="number" />
                    </label>
                  </div>
                  <label class="form-group">
                    <input type="checkbox" id="pharmMedicineRequiresRx" checked /> Requires Prescription
                  </label>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" id="pharmMedicineCancel" class="btn">Cancel</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Stock Tab -->
            <div id="pharmStockPane" hidden>
              <div class="Box p-3 mb-3">
                <div class="d-flex flex-justify-between flex-items-center mb-2">
                  <h4 class="f6 mb-0">Stock Management</h4>
                  <button id="pharmAddStockBtn" class="btn btn-sm btn-primary">+ Add Stock</button>
                </div>
                <div class="d-flex gap-2 mb-2">
                  <select id="pharmStockMedicine" class="form-select flex-1">
                    <option value="">All Medicines</option>
                  </select>
                  <select id="pharmStockStatus" class="form-select" style="width: 150px;">
                    <option value="">All Status</option>
                    <option value="available">Available</option>
                    <option value="low_stock">Low Stock</option>
                    <option value="out_of_stock">Out of Stock</option>
                    <option value="expired">Expired</option>
                    <option value="quarantined">Quarantined</option>
                  </select>
                  <button id="pharmStockLowStock" class="btn btn-sm">Show Low Stock</button>
                  <button id="pharmStockExpired" class="btn btn-sm">Show Expired</button>
                </div>
                <div id="pharmStockList" class="color-fg-muted text-small">Loading stock...</div>
              </div>

              <!-- Add/Edit Stock Modal -->
              <div id="pharmStockModal" class="Box p-3" style="display: none;">
                <h4 class="f6 mb-2" id="pharmStockModalTitle">Add Stock</h4>
                <form id="pharmStockForm" class="d-flex flex-column gap-2">
                  <input type="hidden" id="pharmStockId" />
                  <label class="form-group">
                    <div class="text-small color-fg-muted">Medicine *</div>
                    <select id="pharmStockMedicineSelect" class="form-select input-block" required></select>
                  </label>
                  <div class="d-flex gap-2">
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Quantity *</div>
                      <input id="pharmStockQuantity" class="form-control input-block" type="number" min="0" required />
                    </label>
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Unit</div>
                      <input id="pharmStockUnit" class="form-control input-block" value="units" />
                    </label>
                  </div>
                  <div class="d-flex gap-2">
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Expiry Date *</div>
                      <input id="pharmStockExpiryDate" class="form-control input-block" type="date" required />
                    </label>
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Location</div>
                      <input id="pharmStockLocation" class="form-control input-block" placeholder="e.g., Shelf A-1" />
                    </label>
                  </div>
                  <div class="d-flex gap-2">
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Cost per Unit</div>
                      <input id="pharmStockCost" class="form-control input-block" type="number" step="0.01" />
                    </label>
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Selling Price per Unit</div>
                      <input id="pharmStockPrice" class="form-control input-block" type="number" step="0.01" />
                    </label>
                  </div>
                  <div class="d-flex gap-2">
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Min Stock Level</div>
                      <input id="pharmStockMinLevel" class="form-control input-block" type="number" value="10" />
                    </label>
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Batch ID</div>
                      <input id="pharmStockBatchId" class="form-control input-block" />
                    </label>
                  </div>
                  <label class="form-group">
                    <div class="text-small color-fg-muted">Notes</div>
                    <textarea id="pharmStockNotes" class="form-control input-block" rows="2"></textarea>
                  </label>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" id="pharmStockCancel" class="btn">Cancel</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Quality Verification Tab -->
            <div id="pharmQualityPane" hidden>
              <div class="Box p-3 mb-3">
                <div class="d-flex flex-justify-between flex-items-center mb-2">
                  <h4 class="f6 mb-0">Quality Verification</h4>
                  <button id="pharmAddQualityBtn" class="btn btn-sm btn-primary">+ New Verification</button>
                </div>
                <div id="pharmQualityList" class="color-fg-muted text-small">Loading verifications...</div>
              </div>

              <!-- Quality Verification Modal -->
              <div id="pharmQualityModal" class="Box p-3" style="display: none;">
                <h4 class="f6 mb-2">Quality Verification</h4>
                <form id="pharmQualityForm" class="d-flex flex-column gap-2">
                  <label class="form-group">
                    <div class="text-small color-fg-muted">Medicine *</div>
                    <select id="pharmQualityMedicine" class="form-select input-block" required></select>
                  </label>
                  <div class="d-flex gap-2">
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Batch ID</div>
                      <input id="pharmQualityBatchId" class="form-control input-block" />
                    </label>
                    <label class="form-group flex-1">
                      <div class="text-small color-fg-muted">Stock ID</div>
                      <input id="pharmQualityStockId" class="form-control input-block" />
                    </label>
                  </div>
                  <label class="form-group">
                    <div class="text-small color-fg-muted">Standard *</div>
                    <select id="pharmQualityStandard" class="form-select input-block" required>
                      <option value="">Select Standard...</option>
                      <option value="USP">USP (United States Pharmacopeia)</option>
                      <option value="BP">BP (British Pharmacopoeia)</option>
                      <option value="EP">EP (European Pharmacopoeia)</option>
                      <option value="WHO">WHO (World Health Organization)</option>
                      <option value="IP">IP (Indian Pharmacopoeia)</option>
                      <option value="Other">Other</option>
                    </select>
                  </label>
                  <div class="Box p-2">
                    <div class="text-small color-fg-muted mb-2">Quality Checks</div>
                    <div class="d-flex flex-column gap-2">
                      <label class="d-flex flex-justify-between flex-items-center">
                        <span>Appearance</span>
                        <select id="pharmQualityAppearance" class="form-select" style="width: 150px;">
                          <option value="pending">Pending</option>
                          <option value="pass">Pass</option>
                          <option value="fail">Fail</option>
                        </select>
                      </label>
                      <label class="d-flex flex-justify-between flex-items-center">
                        <span>Packaging</span>
                        <select id="pharmQualityPackaging" class="form-select" style="width: 150px;">
                          <option value="pending">Pending</option>
                          <option value="pass">Pass</option>
                          <option value="fail">Fail</option>
                        </select>
                      </label>
                      <label class="d-flex flex-justify-between flex-items-center">
                        <span>Labeling</span>
                        <select id="pharmQualityLabeling" class="form-select" style="width: 150px;">
                          <option value="pending">Pending</option>
                          <option value="pass">Pass</option>
                          <option value="fail">Fail</option>
                        </select>
                      </label>
                      <label class="d-flex flex-justify-between flex-items-center">
                        <span>Temperature</span>
                        <select id="pharmQualityTemperature" class="form-select" style="width: 150px;">
                          <option value="pending">Pending</option>
                          <option value="pass">Pass</option>
                          <option value="fail">Fail</option>
                        </select>
                      </label>
                      <label class="d-flex flex-justify-between flex-items-center">
                        <span>Expiry</span>
                        <select id="pharmQualityExpiry" class="form-select" style="width: 150px;">
                          <option value="pending">Pending</option>
                          <option value="pass">Pass</option>
                          <option value="fail">Fail</option>
                        </select>
                      </label>
                      <label class="d-flex flex-justify-between flex-items-center">
                        <span>Batch Certificate</span>
                        <select id="pharmQualityBatchCert" class="form-select" style="width: 150px;">
                          <option value="pending">Pending</option>
                          <option value="pass">Pass</option>
                          <option value="fail">Fail</option>
                        </select>
                      </label>
                      <label class="d-flex flex-justify-between flex-items-center">
                        <span>Tamper Evidence</span>
                        <select id="pharmQualityTamper" class="form-select" style="width: 150px;">
                          <option value="pending">Pending</option>
                          <option value="pass">Pass</option>
                          <option value="fail">Fail</option>
                        </select>
                      </label>
                    </div>
                  </div>
                  <label class="form-group">
                    <div class="text-small color-fg-muted">Notes</div>
                    <textarea id="pharmQualityNotes" class="form-control input-block" rows="3"></textarea>
                  </label>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Verify</button>
                    <button type="button" id="pharmQualityCancel" class="btn">Cancel</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Dispense Tab (Original) -->
            <div id="pharmDispensePane" hidden>
              <h4 class="f6 mt-3 mb-2">Dispense Gate (Rx + Batch)</h4>
              <form id="dispenseForm" class="d-flex flex-column gap-2">
                <div class="d-flex flex-justify-between flex-items-center">
                  <div class="text-small color-fg-muted">Prescription JSON</div>
                  <button id="useRxBtn" class="btn btn-sm" type="button">Use last Rx</button>
                </div>
                <textarea id="dispense_rx" class="form-control input-block gz-json" placeholder="Paste signed prescription JSON…"></textarea>
                <div class="d-flex flex-justify-between flex-items-center">
                  <div class="text-small color-fg-muted">Batch JSON</div>
                  <button id="useBatchBtn" class="btn btn-sm" type="button">Use last batch</button>
                </div>
                <textarea id="dispense_batch" class="form-control input-block gz-json" placeholder="Paste signed batch JSON…"></textarea>
                <button class="btn btn-primary" type="submit">Dispense</button>
              </form>
              <textarea id="dispense_out" class="form-control input-block gz-json mt-2" placeholder="Dispense result…"></textarea>
            </div>
          </div>

          <div id="role_admin" hidden>
            <h3 class="f5 mt-3">Admin/Compliance: Audit Log</h3>
            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">User activity</h4>
              <div class="d-flex gap-2 flex-wrap">
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">User</div>
                  <select id="adminUserSelect" class="form-select input-block"></select>
                </label>
                <label class="form-group flex-1">
                  <div class="text-small color-fg-muted">Action filter (optional)</div>
                  <input id="adminActionFilter" class="form-control input-block" placeholder="auth.login_failed" />
                </label>
              </div>
              <div class="d-flex gap-2">
                <button id="adminLoadUserAuditBtn" class="btn btn-sm btn-primary" type="button">Load logs</button>
                <button id="adminUserAuditToggleJsonBtn" class="btn btn-sm" type="button">Show JSON</button>
                <button id="adminUserAuditCopyJsonBtn" class="btn btn-sm" type="button">Copy JSON</button>
              </div>
              <div id="adminUserAuditReadable" class="mt-2"></div>
              <textarea id="adminUserAuditOut" class="form-control input-block gz-json mt-2" hidden placeholder="User-scoped audit logs (JSON)…"></textarea>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Verify patients (clinic code)</h4>
              <div class="d-flex flex-justify-between flex-items-center flex-wrap gap-2">
                <div class="text-small color-fg-muted">Pending patients</div>
                <button id="adminLoadPendingBtn" class="btn btn-sm" type="button">Refresh list</button>
              </div>
              <div class="mt-2">
                <select id="adminPendingSelect" class="form-select input-block"></select>
              </div>

              <form id="clinicCodeForm" class="d-flex flex-column gap-2">
                <div class="d-flex gap-2">
                  <label class="form-group flex-1">
                    <div class="text-small color-fg-muted">Bind to patientId</div>
                    <input id="cc_patientId" class="form-control input-block" placeholder="u_patient_..." />
                  </label>
                  <label class="form-group flex-1">
                    <div class="text-small color-fg-muted">Expires (minutes)</div>
                    <input id="cc_expires" class="form-control input-block" type="number" value="10" />
                  </label>
                </div>
                <label class="form-group">
                  <div class="text-small color-fg-muted">Delivery</div>
                  <div class="form-checkbox">
                    <label>
                      <input id="cc_sendEmail" type="checkbox" checked />
                      Send code to patient email (SMTP required)
                    </label>
                  </div>
                </label>
                <button class="btn btn-sm" type="submit">Generate code</button>
              </form>
              <div class="mt-2">
                <div class="text-small color-fg-muted">Generated code</div>
                <div class="d-flex gap-2 flex-items-center">
                  <code id="cc_code" class="gz-mono">—</code>
                  <button id="cc_copy" class="btn btn-sm" type="button">Copy</button>
                </div>
                <div class="text-small color-fg-muted mt-1">
                  Expiry: <span id="cc_expiry" class="gz-mono">—</span>
                </div>
                <div class="text-small color-fg-muted mt-1">
                  Delivery: <span id="cc_delivery" class="gz-mono">—</span> • Sent to: <span id="cc_sentTo" class="gz-mono">—</span>
                </div>
              </div>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">SMTP test</h4>
              <div class="d-flex flex-justify-between flex-items-center flex-wrap gap-2">
                <div class="text-small color-fg-muted">Connectivity/auth check</div>
                <button id="smtpStatusBtn" class="btn btn-sm" type="button">Verify SMTP</button>
              </div>
              <code id="smtpStatusOut" class="gz-mono d-block mt-2">—</code>
              <form id="mailTestForm" class="d-flex flex-column gap-2">
                <label class="form-group">
                  <div class="text-small color-fg-muted">Send test email to</div>
                  <input id="mailTestTo" class="form-control input-block" placeholder="you@example.com" />
                </label>
                <button class="btn btn-sm" type="submit">Send test</button>
              </form>
              <div class="text-small color-fg-muted mt-1">
                Uses <span class="gz-mono">POST /admin/mail/test</span>. If it fails, error details will show in the toast.
              </div>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">System audit</h4>
              <div class="d-flex gap-2 flex-wrap">
                <button id="auditLoadBtn" class="btn btn-primary btn-sm" type="button">Load latest 200</button>
                <button id="auditToggleJsonBtn" class="btn btn-sm" type="button">Show JSON</button>
                <button id="auditCopyJsonBtn" class="btn btn-sm" type="button">Copy JSON</button>
              </div>
              <div id="auditReadable" class="mt-2"></div>
              <textarea id="audit_out" class="form-control input-block gz-json mt-2" hidden placeholder="Audit entries (JSON)…"></textarea>
            </div>
          </div>

          <div id="role_patient" hidden>
            <h3 class="f5 mt-3">Patient</h3>
            
            <div class="Box p-3 mb-3">
              <h4 class="f6 mb-2">Book Appointment with Doctor</h4>
              <form id="appointmentForm" class="d-flex flex-column gap-2">
                <label class="form-group">
                  <div class="text-small color-fg-muted">Select Doctor</div>
                  <select id="apt_doctorId" class="form-select input-block"></select>
                </label>
                <div class="d-flex gap-2">
                  <label class="form-group flex-1">
                    <div class="text-small color-fg-muted">Appointment Date</div>
                    <input id="apt_date" class="form-control input-block" type="date" required />
                  </label>
                  <label class="form-group flex-1">
                    <div class="text-small color-fg-muted">Appointment Time</div>
                    <input id="apt_time" class="form-control input-block" type="time" required />
                  </label>
                </div>
                <label class="form-group">
                  <div class="text-small color-fg-muted">Notes (optional)</div>
                  <textarea id="apt_notes" class="form-control input-block" rows="2" placeholder="Any additional notes..."></textarea>
                </label>
                <button class="btn btn-primary" type="submit">Book Appointment</button>
              </form>
              <div id="apt_out" class="mt-2"></div>
            </div>
            
            <div class="Box p-3 mb-3">
              <h4 class="f6 mb-2">My Appointments</h4>
              <button id="loadAppointmentsBtn" class="btn btn-sm btn-primary mb-2">Load Appointments</button>
              <div id="appointmentsList" class="color-fg-muted text-small">Click to load your appointments</div>
            </div>
            
            <div class="Box p-2 mt-2">
              <div class="d-flex flex-justify-between flex-items-center">
                <h4 class="f6 mb-0">Profile</h4>
                <button id="patientRefreshBtn" class="btn btn-sm" type="button">Refresh</button>
              </div>
              <textarea id="patient_profile_out" class="form-control input-block gz-json mt-2" placeholder="Profile…"></textarea>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Enable MFA (Email OTP)</h4>
              <form id="patientMfaForm" class="d-flex flex-column gap-2">
                <label class="form-group">
                  <div class="text-small color-fg-muted">Email (optional)</div>
                  <input id="patient_mfa_email" class="form-control input-block" placeholder="you@example.com" />
                </label>
                <button class="btn btn-sm" type="submit">Enable Email OTP MFA</button>
              </form>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Disable MFA</h4>
              <button id="mfaDisableRequestBtn" class="btn btn-sm btn-danger" type="button">Send disable code</button>
              <div id="mfaDisableBox" class="mt-2" hidden>
                <div class="text-small color-fg-muted">Enter OTP sent to your email</div>
                <div class="d-flex gap-2 mt-2">
                  <input id="mfaDisableOtp" class="form-control" placeholder="123456" inputmode="numeric" />
                  <button id="mfaDisableConfirmBtn" class="btn btn-primary btn-sm" type="button">Disable</button>
                </div>
                <div class="text-small color-fg-muted mt-2">
                  otpRequestId: <span id="mfaDisableOtpId" class="gz-mono">—</span>
                </div>
              </div>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Trusted device</h4>
              <div class="d-flex flex-justify-between flex-items-center flex-wrap gap-2">
                <div class="text-small color-fg-muted">Devices trusted for OTP bypass</div>
                <button id="trustedRefreshBtn" class="btn btn-sm" type="button">Refresh</button>
              </div>
              <select id="trustedSelect" class="form-select input-block mt-2"></select>

              <div class="d-flex gap-2 mt-2">
                <button id="trustedRemoveBtn" class="btn btn-sm btn-danger" type="button">Remove selected (email OTP)</button>
              </div>

              <div id="trustedRemoveOtpBox" class="Box p-2 mt-2" hidden>
                <div class="text-small color-fg-muted">Enter the OTP sent to your email to confirm removal.</div>
                <div class="d-flex gap-2 mt-2">
                  <input id="trustedRemoveOtp" class="form-control" placeholder="123456" inputmode="numeric" />
                  <button id="trustedRemoveConfirmBtn" class="btn btn-primary btn-sm" type="button">Confirm</button>
                </div>
                <div class="text-small color-fg-muted mt-2">
                  otpRequestId: <span id="trustedRemoveOtpId" class="gz-mono">—</span>
                </div>
              </div>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Issue DID</h4>
              <button id="patientIssueDidBtn" class="btn btn-sm" type="button">Issue DID</button>
              <code id="patient_did" class="gz-mono d-block mt-2">—</code>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Provision data key</h4>
              <button id="patientProvisionKeyBtn" class="btn btn-sm" type="button">Provision</button>
              <div class="text-small color-fg-muted mt-1">
                Patient token: <span id="patient_token" class="gz-mono">—</span>
              </div>
            </div>

            <div class="Box p-2 mt-2">
              <h4 class="f6 mb-2">Device binding</h4>
              <p class="color-fg-muted text-small mb-2">
                Automatic: this browser generates a device key, binds once, then signs challenges automatically (no manual copy/paste).
              </p>
              <div class="d-flex flex-items-center flex-justify-between flex-wrap gap-2">
                <div class="text-small color-fg-muted">
                  Device ID: <span id="autoDeviceId" class="gz-mono">—</span>
                </div>
                <div class="d-flex gap-2">
                  <button id="autoBindBtn" class="btn btn-sm" type="button">Bind/Verify now</button>
                </div>
              </div>
              <textarea id="autoBindOut" class="form-control input-block gz-json mt-2" placeholder="Device bind status/output…"></textarea>
            </div>
          </div>
        </section>
      </div>

      <footer class="mt-4 color-fg-muted text-small">
        Tip: run <span class="gz-mono">npm run seed</span> then <span class="gz-mono">npm run dev</span>.
      </footer>
    </main>

    <script src="app.js" type="module"></script>
  </body>
</html>
